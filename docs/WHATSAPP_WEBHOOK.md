# Webhook واتساب – المنطق النهائي

يتم استهلاك Webhook Meta Cloud من خلال `POST /webhook/whatsapp` وفقًا للخطوات التالية:

1. **التعرف على المستأجر**  
   يتم استخراج `phone_number_id` من `value.metadata` ثم البحث عن المستأجر المقابل (`tenants.whatsapp_phone_number_id`). في حال عدم العثور يتم تسجيل تحذير وإهمال الرسالة.

2. **تسجيل العميل والمحادثة**  
   - إنشاء/تحديث سجل `customers` عبر رقم الـ `wa_id`.  
   - حفظ رسالة جديدة داخل حقل JSON `conversations.messages` مع `from = customer|bot|agent`.  
   - بث تحديث فوري عبر Socket.io (`/service` namespace) باستخدام الحدث `conversation_update`.

3. **معالجة أنواع الرسائل**  
   - **مشاركة الموقع**: يتم تمرير الإحداثيات على جميع `zones` الخاصة بالمستأجر باستخدام خوارزمية نقطة داخل مضلع (GeoJSON). يتم الرد برسوم التوصيل وحد الطلب الأدنى أو رسالة خارج التغطية.  
   - **النصوص**: يتم تمرير النص إلى خدمة OpenAI (`AiService`) لتصنيف النية ضمن:  
     `ASK_DELIVERY_FEE`, `PROMOTION_QUERY`, `OOS_ALTERNATIVES`, `SMALL_TALK`.  
     - عند اكتشاف كوبون يتم التحقق من جدول `promotions`.  
     - عند طلب بدائل يتم استدعاء خدمة المنتجات لإرجاع 3 اقتراحات كرسالة Interactive List.
   - **الرد التفاعلي/الأزرار**: إذا اختار العميل `cancel_item` يتم إبلاغه بإلغاء الصنف، أما اختيار أحد البدائل فيتم تأكيد التبديل.

4. **قنوات الرد**  
   يتم إرسال كل الردود عبر Meta Graph API (`https://graph.facebook.com/v18.0/{PHONE_ID}/messages`) باستخدام `WHATSAPP_ACCESS_TOKEN`. يدعم الأنواع:
   - رسائل نصية عادية (رسوم، أكواد، تأكيد).  
   - Interactive List للبدائل (تعرِض الاسم، الصورة، السعر، وزر "لا أرغب، قم بإلغاء الصنف").

5. **الاتصال بخدمات داخلية**  
   - لا يتم استدعاء أي خدمة خارجية للتسعير أو المخزون؛ كل شيء مأخوذ من PostgreSQL.  
   - يتم استدعاء OpenAI فقط لتحليل النصوص وتحديد النية/المنتج المذكور.

6. **الأمان**  
   - Endpoint التحقق `GET /webhook/whatsapp` يقارن `hub.verify_token` مع المتغير `WHATSAPP_VERIFY_TOKEN`.  
   - جميع الردود الصادرة تحمل التوكن السري في الترويسة، مع مهلة 10 ثوانٍ للطلبات.
